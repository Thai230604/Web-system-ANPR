{% extends "base.html" %}

{% block title %}License Plates - ANPR System{% endblock %}

{% block content %}
<h2>Plate Management</h2>

<!-- Error Alert -->
<div id="error-msg" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <span id="error-text"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Form Create / Edit -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h4 class="card-title" id="form-title">Create New Plate</h4>
        <form id="plateForm" onsubmit="handleSubmit(event)">
            <div class="row">
                <div class="col-md-4 mb-3" id="plate-text-div">
                    <label class="form-label fw-bold">Plate Text <span class="text-danger">*</span></label>
                    <input type="text" class="form-control text-uppercase" id="plate_text" required placeholder="51-H1123.45">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Province <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="province" required placeholder="Hồ Chí Minh">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Vehicle Type <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="vehicle_type" required placeholder="Car">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Owner Name</label>
                    <input type="text" class="form-control" id="owner_name" placeholder="Nguyễn Văn A">
                </div>
                <div class="col-md-6 mb-3">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="is_blacklisted">
                        <label class="form-check-label fw-bold text-danger" for="is_blacklisted">
                            Blacklisted Vehicle
                        </label>
                    </div>
                </div>
            </div>

            <div class="mb-3" id="blacklist-reason-div" style="display: none;">
                <label class="form-label">Blacklist Reason</label>
                <input type="text" class="form-control border-danger" id="blacklist_reason" placeholder="Ví dụ: Trộm cắp, vi phạm nghiêm trọng...">
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary px-4" id="submitBtn">Create Plate</button>
                <button type="button" class="btn btn-secondary px-4 d-none" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Plates Table -->
<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title mb-3">Registered Plates</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Plate</th>
                        <th>Province</th>
                        <th>Vehicle Type</th>
                        <th>Owner</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody id="platesTable">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">Loading plates...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Tự động lấy origin → dev, prod đều chạy ngon
const API_BASE = 'http://localhost:8000/api/plates';
let plates = [];
let editId = null;

// ✅ Lấy authorization header từ cookie hoặc localStorage
function getAuthHeader() {
    const token = localStorage.getItem('access_token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// Show/hide blacklist reason
document.getElementById('is_blacklisted').addEventListener('change', function () {
    document.getElementById('blacklist-reason-div').style.display = this.checked ? 'block' : 'none';
    if (!this.checked) document.getElementById('blacklist_reason').value = '';
});

document.addEventListener('DOMContentLoaded', loadPlates);

async function loadPlates() {
    try {
        const res = await fetch(API_BASE, { headers: getAuthHeader() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        plates = await res.json();
        renderPlates();
    } catch (err) {
        console.error(err);
        document.getElementById('platesTable').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger">Failed to load plates<br><small>${err.message}</small></td></tr>
        `;
    }
}

function renderPlates() {
    const tbody = document.getElementById('platesTable');
    if (!plates || plates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No plates registered yet</td></tr>';
        return;
    }

    tbody.innerHTML = plates.map(p => `
        <tr>
            <td><strong class="text-primary">${escapeHtml(p.plate_text)}</strong></td>
            <td>${escapeHtml(p.province) || '-'}</td>
            <td>${escapeHtml(p.vehicle_type) || '-'}</td>
            <td>${escapeHtml(p.owner_name) || '-'}</td>
            <td>
                ${p.is_blacklisted 
                    ? '<span class="badge bg-danger">Blacklisted</span>' 
                    : '<span class="badge bg-success">Normal</span>'
                }
            </td>
            <td class="text-danger">${escapeHtml(p.blacklist_reason) || '-'}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPlate(${p.id})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deletePlate(${p.id})">Delete</button>
            </td>
        </tr>
    `).join('');
}

async function handleSubmit(e) {
    e.preventDefault();
    hideError();

    const formData = {
        plate_text: document.getElementById('plate_text').value.trim().toUpperCase(),
        province: document.getElementById('province').value.trim(),
        vehicle_type: document.getElementById('vehicle_type').value.trim(),
        owner_name: document.getElementById('owner_name').value.trim(),
        is_blacklisted: document.getElementById('is_blacklisted').checked,
        blacklist_reason: document.getElementById('blacklist_reason').value.trim()
    };

    // Payload đúng chuẩn backend
    const payload = editId ? {
        province: formData.province || null,
        vehicle_type: formData.vehicle_type || null,
        owner_name: formData.owner_name || null,
        is_blacklisted: formData.is_blacklisted,
        blacklist_reason: formData.is_blacklisted ? (formData.blacklist_reason || null) : null
    } : {
        plate_text: formData.plate_text,
        province: formData.province || null,
        vehicle_type: formData.vehicle_type || null,
        owner_name: formData.owner_name || null,
        is_blacklisted: formData.is_blacklisted,
        blacklist_reason: formData.is_blacklisted ? (formData.blacklist_reason || null) : null
    };

    try {
        const url = editId ? `${API_BASE}/${editId}` : API_BASE;
        const method = editId ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            resetForm();
            loadPlates();
        } else {
            const err = await res.json();
            showError(err.detail || 'Operation failed');
        }
    } catch (err) {
        showError('Server connection error');
    }
}

function editPlate(id) {
    const plate = plates.find(p => p.id === id);
    if (!plate) return;

    editId = id;
    document.getElementById('plate_text').value = plate.plate_text;
    document.getElementById('province').value = plate.province || '';
    document.getElementById('vehicle_type').value = plate.vehicle_type || '';
    document.getElementById('owner_name').value = plate.owner_name || '';
    document.getElementById('is_blacklisted').checked = plate.is_blacklisted;
    document.getElementById('blacklist_reason').value = plate.blacklist_reason || '';
    document.getElementById('blacklist-reason-div').style.display = plate.is_blacklisted ? 'block' : 'none';

    document.getElementById('plate-text-div').style.display = 'none';
    document.getElementById('form-title').textContent = 'Edit Plate';
    document.getElementById('submitBtn').textContent = 'Update Plate';
    document.getElementById('cancelBtn').classList.remove('d-none');
}

function cancelEdit() {
    resetForm();
}

function resetForm() {
    editId = null;
    document.getElementById('plateForm').reset();
    document.getElementById('plate-text-div').style.display = 'block';
    document.getElementById('blacklist-reason-div').style.display = 'none';
    document.getElementById('form-title').textContent = 'Create New Plate';
    document.getElementById('submitBtn').textContent = 'Create Plate';
    document.getElementById('cancelBtn').classList.add('d-none');
}

async function deletePlate(id) {
    if (!confirm('Are you sure you want to delete this plate?')) return;

    try {
        const res = await fetch(`${API_BASE}/${id}`, {
            method: 'DELETE',
            headers: getAuthHeader()
        });
        if (res.ok) loadPlates();
        else showError('Delete failed');
    } catch {
        showError('Server error');
    }
}

function showError(msg) {
    document.getElementById('error-text').textContent = msg;
    document.getElementById('error-msg').classList.remove('d-none');
}

function hideError() {
    document.getElementById('error-msg').classList.add('d-none');
}

// Bảo vệ XSS nhẹ
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}
{% extends "base.html" %}

{% block title %}History - ANPR System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">ðŸš— Detection History</h1>
    </div>
</div>

<!-- Filter Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Limit</label>
                        <input type="number" id="limitInput" class="form-control" value="50" min="1" max="500">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search Plate</label>
                        <input type="text" id="searchInput" class="form-control text-uppercase" placeholder="51H-12345">
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button class="btn btn-primary" onclick="loadHistory()">ðŸ”„ Load</button>
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Alert -->
<div id="status-alert" class="alert alert-info alert-dismissible fade show d-none" role="alert">
    <span id="status-text">Loading...</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Table Section -->
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">ðŸ“‹ All Detections (<span id="detection-count">0</span>)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>License Plate</th>
                                <th>Owner</th>
                                <th>Province</th>
                                <th>Confidence</th>
                                <th>Status</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Loading detections...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allDetections = [];

function getAuthHeader() {
    const token = localStorage.getItem('access_token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

async function loadHistory() {
    const limit = document.getElementById('limitInput').value || 50;
    const searchText = document.getElementById('searchInput').value.toUpperCase().trim();
    
    showStatus('Loading detections...');
    
    try {
        // Gá»­i search parameter tá»›i API
        const searchParam = searchText ? `&search=${encodeURIComponent(searchText)}` : '';
        const url = `/stream/detections-history?limit=${limit}${searchParam}`;
        
        const response = await fetch(url, {
            headers: getAuthHeader()
        });
        
        if (!response.ok) {
            showStatus(`Error: ${response.status}`, 'danger');
            return;
        }
        
        const data = await response.json();
        
        if (!data.success || !data.detections) {
            showStatus('No detections found', 'warning');
            renderTable([]);
            return;
        }
        
        allDetections = data.detections;
        renderTable(allDetections);
        showStatus(`Loaded ${allDetections.length} detections`, 'success');
        
    } catch (err) {
        console.error('Error loading history:', err);
        showStatus(`Error: ${err.message}`, 'danger');
    }
}

function renderTable(detections) {
    const tbody = document.getElementById('historyTable');
    const countSpan = document.getElementById('detection-count');
    
    countSpan.textContent = detections.length;
    
    if (!detections || detections.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No detections found</td></tr>';
        return;
    }
    
    tbody.innerHTML = detections.map(d => {
        const timestamp = new Date(d.timestamp).toLocaleString('vi-VN');
        const confidence = (d.confidence * 100).toFixed(1);
        
        let statusBadge = '';
        let reasonText = '-';
        
        if (d.is_blacklisted) {
            statusBadge = '<span class="badge bg-danger">ðŸš« BLACKLIST</span>';
            reasonText = d.blacklist_reason || 'N/A';
        } else if (d.is_verified) {
            statusBadge = '<span class="badge bg-success">âœ“ Verified</span>';
        } else {
            statusBadge = '<span class="badge bg-warning">? Unknown</span>';
        }
        
        return `
            <tr>
                <td><small>${timestamp}</small></td>
                <td>
                    <strong class="text-primary">${escapeHtml(d.plate_text)}</strong>
                </td>
                <td>${escapeHtml(d.plate_owner || '-')}</td>
                <td>${escapeHtml(d.plate_province || '-')}</td>
                <td>
                    <span class="badge ${getConfidenceBadge(d.confidence)}">
                        ${confidence}%
                    </span>
                </td>
                <td>${statusBadge}</td>
                <td class="text-danger"><small>${escapeHtml(reasonText)}</small></td>
            </tr>
        `;
    }).join('');
}

function getConfidenceBadge(confidence) {
    if (confidence >= 0.9) return 'bg-success';
    if (confidence >= 0.7) return 'bg-warning text-dark';
    return 'bg-danger';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showStatus(message, type = 'info') {
    const alert = document.getElementById('status-alert');
    const text = document.getElementById('status-text');
    
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    text.textContent = message;
    alert.classList.remove('d-none');
    
    if (type === 'success') {
        setTimeout(() => alert.classList.add('d-none'), 3000);
    }
}

function clearFilters() {
    document.getElementById('limitInput').value = '50';
    document.getElementById('searchInput').value = '';
    loadHistory();
}

// Load lÃºc page open
document.addEventListener('DOMContentLoaded', loadHistory);
</script>

<style>
#historyTable tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
    cursor: pointer;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-weight: 600;
    padding: 0.5em 0.8em;
}
</style>

{% endblock %}
